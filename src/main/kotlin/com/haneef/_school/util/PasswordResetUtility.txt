package com.haneef._school.util

import com.haneef._school.repository.UserRepository
import org.springframework.boot.CommandLineRunner
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import org.springframework.security.crypto.password.PasswordEncoder
import org.springframework.stereotype.Component

/**
 * Utility to reset all user passwords to @Pass123
 * 
 * IMPORTANT: This is a one-time utility for development/testing purposes.
 * Comment out or delete after use to prevent accidental password resets.
 * 
 * To use:
 * 1. Uncomment the @Component annotation
 * 2. Restart the application
 * 3. The passwords will be updated on startup
 * 4. Comment out @Component again to prevent future resets
 */
@Component  // UNCOMMENT THIS LINE TO ACTIVATE
class PasswordResetUtility(
    private val userRepository: UserRepository,
    private val passwordEncoder: PasswordEncoder
) : CommandLineRunner {

    override fun run(vararg args: String?) {
        val newPassword = "@Pass123"
        val encodedPassword = passwordEncoder.encode(newPassword)
        
        println("========================================")
        println("RESETTING ALL USER PASSWORDS")
        println("========================================")
        println("New Password: $newPassword")
        println("BCrypt Hash: $encodedPassword")
        println("========================================")
        
        // Get all users
        val users = userRepository.findAll()
        var updatedCount = 0
        
        users.forEach { user ->
            user.passwordHash = encodedPassword
            userRepository.save(user)
            updatedCount++
            println("Updated password for user: ${user.email ?: user.phoneNumber}")
        }
        
        println("========================================")
        println("PASSWORD RESET COMPLETE")
        println("Total users updated: $updatedCount")
        println("========================================")
        println("IMPORTANT: Comment out @Component annotation in PasswordResetUtility.kt")
        println("to prevent passwords from being reset on every startup!")
        println("========================================")
    }
}
