<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4School - Parent Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/parent-dashboard.css}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- CSRF Meta Tags -->
    <div th:replace="~{fragments/csrf :: csrf-meta}"></div>
    <!-- Include CSRF JavaScript -->
    <div th:replace="~{fragments/csrf :: csrf-js}"></div>

    <!-- Custom scripts removed, using dashboard-tabs.js -->
</head>

<body>
    <div th:replace="~{fragments/header :: school-header}"></div>

    <main class="main-content">
        <div class="dashboard-container role-parent">
            <div class="alert alert-warning" th:if="${isViewAs}"
                style="margin-bottom: 20px; border-left: 5px solid #f59e0b; background-color: #fffbeb; color: #92400e; padding: 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-eye"></i>
                <span><strong>Viewing as Admin:</strong> You are currently viewing the dashboard of <span
                        th:text="${viewingAsName}">Parent Name</span>.</span>
            </div>

            <div class="welcome-section">
                <div class="welcome-text">
                    <h1>Welcome back, <span th:text="${user.firstName}">Parent</span>!</h1>
                    <p th:if="${school}">Managing your children's education at <strong th:text="${school.name}">School
                            Name</strong></p>
                </div>
                <div class="welcome-stats">
                    <div class="stat-badge">
                        <span class="value" th:text="${children.size()}">0</span>
                        <span class="label">Children</span>
                    </div>
                    <div class="stat-badge">
                        <span class="value"
                            th:text="${'â‚¦' + #numbers.formatDecimal(balance, 1, 'COMMA', 0, 'POINT')}">â‚¦0</span>
                        <span class="label">Balance</span>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-btn active" data-tab-target="overview-tab">Overview</button>
                    <button class="tab-btn" data-tab-target="financial-tab">Financial</button>
                    <button class="tab-btn" data-tab-target="children-tab">Children</button>
                </div>

                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-pane active">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="card-title">My Children</span>
                                <div class="card-icon"><i class="fas fa-user-graduate"></i></div>
                            </div>
                            <div class="card-value" th:text="${children.size()}">0</div>
                            <div class="card-trend">
                                <span class="trend-neutral">Enrolled students</span>
                            </div>
                            <button class="card-link tab-btn" data-tab-target="children-tab"
                                style="background:none; border:none; width:100%; text-align:left; padding-left:0;">
                                View Children <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>

                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="card-title">Fees & Payments</span>
                                <div class="card-icon"><i class="fas fa-wallet"></i></div>
                            </div>
                            <div class="card-value"
                                th:text="${'â‚¦' + #numbers.formatDecimal(balance, 1, 'COMMA', 0, 'POINT')}">â‚¦0</div>
                            <div class="card-trend">
                                <span class="trend-neutral">Current Balance</span>
                            </div>
                            <button class="card-link tab-btn" data-tab-target="financial-tab"
                                style="background:none; border:none; width:100%; text-align:left; padding-left:0;">
                                View Financials <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="content-panel">
                            <div class="section-header">
                                <h2 class="section-title">Upcoming Events</h2>
                            </div>
                            <div class="activity-list">
                                <div class="activity-item">
                                    <div class="activity-icon-wrapper">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div class="activity-details">
                                        <h4>Parent-Teacher Conference</h4>
                                        <p>Individual meetings with teachers</p>
                                        <span class="activity-time">Dec 15</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon-wrapper">
                                        <i class="fas fa-snowflake"></i>
                                    </div>
                                    <div class="activity-details">
                                        <h4>Winter Break Begins</h4>
                                        <p>School closes for winter holidays</p>
                                        <span class="activity-time">Dec 20</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="content-panel">
                            <div class="section-header">
                                <h2 class="section-title">Recent Activity</h2>
                            </div>
                            <div class="activity-list">
                                <div class="activity-item">
                                    <div class="activity-icon-wrapper">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <div class="activity-details">
                                        <h4>Grade Update - Emma</h4>
                                        <p>Mathematics test: 92/100</p>
                                        <span class="activity-time">2 hours ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon-wrapper">
                                        <i class="fas fa-pen"></i>
                                    </div>
                                    <div class="activity-details">
                                        <h4>Assignment Due - Michael</h4>
                                        <p>Science project due tomorrow</p>
                                        <span class="activity-time">5 hours ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Tab -->
                <div id="financial-tab" class="tab-pane">
                    <div id="fees-overview-section" class="fees-overview-section" th:fragment="fees-overview-section">
                        <div class="content-panel">
                            <div class="section-header">
                                <h2 class="section-title">ðŸ’° Financial Overview</h2>
                            </div>

                            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                            <p class="text-muted mb-4">Track your children's school fees and payments</p>

                            <!-- Payment Progress Bar -->
                            <div class="payment-progress-container mb-4"
                                th:with="percentage=${totalFees > 0 ? (totalSettled * 100.0 / totalFees) : 0}">
                                <div class="progress-info"
                                    style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span class="progress-label font-weight-bold">Payment Progress</span>
                                    <span class="progress-percentage font-weight-bold"
                                        th:text="${#numbers.formatDecimal(percentage, 1, 'POINT', 1, 'POINT') + '%'}">0.0%</span>
                                </div>
                                <div class="progress-bar-bg"
                                    style="background: #e2e8f0; border-radius: 999px; height: 10px; overflow: hidden;">
                                    <div class="progress-bar-fill"
                                        th:style="'width: ' + ${percentage} + '%; background: var(--success-color); height: 100%; transition: width 0.5s ease;'"
                                        role="progressbar" th:aria-valuenow="${percentage}" aria-valuemin="0"
                                        aria-valuemax="100"></div>
                                </div>
                            </div>

                            <!-- Payment Distribution Settings -->
                            <div id="payment-settings-container" class="payment-distribution-settings"
                                th:if="${wallet != null}" style="margin-top: 2rem;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Payment Distribution
                                    </h3>
                                    <span th:if="${paymentLocked}" class="badge badge-warning">
                                        ðŸ”’ Settings Locked (Payments Started)
                                    </span>
                                </div>

                                <form th:action="@{/parent/update-payment-settings}" method="post"
                                    class="distribution-form" th:attr="hx-post=@{/parent/update-payment-settings}"
                                    hx-target="#payment-settings-container" hx-swap="outerHTML">
                                    <div class="distribution-options"
                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <label class="radio-option" th:classappend="${paymentLocked ? 'disabled' : ''}"
                                            style="border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--radius-md); cursor: pointer; display: flex; gap: 0.5rem;">
                                            <input type="radio" name="distributionType" value="SPREAD"
                                                th:checked="${parent.paymentDistributionType == 'SPREAD'}"
                                                th:disabled="${paymentLocked}" onchange="toggleSequentialOrder(false)">
                                            <div class="option-content">
                                                <span class="option-title"
                                                    style="display: block; font-weight: 600;">Spread Across All</span>
                                                <span class="option-desc"
                                                    style="font-size: 0.85rem; color: var(--text-muted);">Payments are
                                                    split equally among all children with outstanding fees.</span>
                                            </div>
                                        </label>
                                        <label class="radio-option" th:classappend="${paymentLocked ? 'disabled' : ''}"
                                            style="border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--radius-md); cursor: pointer; display: flex; gap: 0.5rem;">
                                            <input type="radio" name="distributionType" value="SEQUENTIAL"
                                                th:checked="${parent.paymentDistributionType == 'SEQUENTIAL'}"
                                                th:disabled="${paymentLocked}" onchange="toggleSequentialOrder(true)">
                                            <div class="option-content">
                                                <span class="option-title"
                                                    style="display: block; font-weight: 600;">Sequential</span>
                                                <span class="option-desc"
                                                    style="font-size: 0.85rem; color: var(--text-muted);">Payments clear
                                                    fees for one child at a time based on your priority order.</span>
                                            </div>
                                        </label>
                                    </div>

                                    <div id="sequential-order-container" class="sequential-order-container"
                                        th:style="${parent.paymentDistributionType == 'SEQUENTIAL' ? 'display: block;' : 'display: none;'}"
                                        style="background: var(--bg-body); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                                        <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Priority
                                            Order <span th:if="${!paymentLocked}"
                                                style="font-weight: normal; font-size: 0.85rem;">(Drag to
                                                Reorder)</span></h4>
                                        <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;"
                                            th:text="${paymentLocked ? 'Fixed order for current payments.' : 'Top child gets paid first.'}">
                                            Top child gets paid first.</p>
                                        <ul id="sortable-children" class="sortable-list"
                                            th:classappend="${paymentLocked ? 'locked' : ''}"
                                            style="list-style: none; padding: 0;">
                                            <li th:each="child : ${children}" class="sortable-item"
                                                th:data-id="${child.id}"
                                                style="background: white; padding: 0.75rem; border: 1px solid var(--border-color); margin-bottom: 0.5rem; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 0.5rem;">
                                                <span class="drag-handle" th:if="${!paymentLocked}"
                                                    style="cursor: move; color: var(--text-light);">â˜°</span>
                                                <span th:text="${child.user.fullName}">Student Name</span>
                                                <input type="hidden" name="childPriority[]" th:value="${child.id}">
                                            </li>
                                        </ul>
                                    </div>

                                    <button th:if="${!paymentLocked}" type="submit" id="save-settings-btn"
                                        class="btn btn-primary btn-sm">Save Preferences</button>
                                </form>
                            </div>
                        </div>

                        <div class="dashboard-grid" style="margin-top: 1.5rem;">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-title">Total Bill</span>
                                    <div class="card-icon"><i class="fas fa-file-invoice"></i></div>
                                </div>
                                <div class="card-value"
                                    th:text="${'â‚¦' + #numbers.formatDecimal(totalFees, 1, 'COMMA', 2, 'POINT')}">â‚¦0.00
                                </div>
                                <div class="card-trend">
                                    <span class="trend-neutral">Required Fees</span>
                                </div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-title">Settled</span>
                                    <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                                </div>
                                <div class="card-value text-success"
                                    th:text="${'â‚¦' + #numbers.formatDecimal(totalSettled, 1, 'COMMA', 2, 'POINT')}">
                                    â‚¦0.00</div>
                                <div class="card-trend">
                                    <span class="trend-up">Amount Paid</span>
                                </div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-title">Balance</span>
                                    <div class="card-icon"><i class="fas fa-balance-scale"></i></div>
                                </div>
                                <div class="card-value" th:classappend="${balance > 0 ? 'text-danger' : 'text-success'}"
                                    th:text="${'â‚¦' + #numbers.formatDecimal(balance, 1, 'COMMA', 2, 'POINT')}">â‚¦0.00
                                </div>
                                <div class="card-trend">
                                    <span class="trend-down">Outstanding</span>
                                </div>
                            </div>

                            <div class="dashboard-card" th:if="${wallet != null}" th:id="'wallet-card-' + ${wallet.id}"
                                th:attr="hx-get=${wallet.accountNumber == null ? '/parent/dashboard' : null}, 
                                      hx-trigger=${wallet.accountNumber == null ? 'every 3s' : null},
                                      hx-select='#fees-overview-section',
                                      hx-target='#fees-overview-section',
                                      hx-swap='outerHTML'">
                                <div class="card-header">
                                    <span class="card-title">Payment Account</span>
                                    <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                                </div>
                                <div class="card-value account-number"
                                    th:text="${wallet.accountNumber ?: 'Generating...'}"
                                    th:classappend="${wallet.accountNumber == null ? 'pulse-text' : 'fade-in-text'}"
                                    style="font-size: 1.5rem;">
                                    0000000000
                                </div>
                                <div class="card-trend">
                                    <span th:text="${wallet.bankName}">Bank Name</span>
                                    <span th:if="${wallet.accountName != null}"
                                        th:text="' | ' + ${wallet.accountName}">Account Name</span>
                                    <span th:if="${wallet.accountNumber == null}" class="loading-dots">...</span>
                                </div>
                            </div>

                            <div class="dashboard-card" th:if="${wallet == null}">
                                <div class="card-header">
                                    <span class="card-title">Payment Account</span>
                                    <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                                </div>
                                <div class="card-value" style="font-size: 1.25rem; color: var(--text-muted);">Not Yet
                                    Assigned</div>
                                <form th:action="@{/parent/create-wallet}" method="post" style="margin-top: 1rem;">
                                    <div style="margin-bottom: 10px;">
                                        <select name="preferredBank" class="form-select" style="width: 100%;">
                                            <option th:each="provider : ${providers}"
                                                th:value="${provider.providerSlug}" th:text="${provider.bankName}">Bank
                                                Name</option>
                                            <option th:if="${providers == null || #lists.isEmpty(providers)}"
                                                value="wema-bank">Wema Bank</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm" style="width: 100%;">Create
                                        Account</button>
                                </form>
                            </div>
                        </div>

                        <!-- Breakdown Section -->
                        <div id="fee-breakdown" class="content-panel" style="margin-top: 2rem;">
                            <div class="section-header">
                                <h3 class="section-title">Detailed Breakdown by Child</h3>
                            </div>

                            <div class="dashboard-grid">
                                <div th:each="childFee : ${feeBreakdown}" class="dashboard-card">
                                    <div class="card-header">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div class="activity-icon-wrapper"
                                                style="width: 32px; height: 32px; font-size: 0.9rem;">
                                                <span
                                                    th:text="${#strings.substring(childFee.studentName, 0, 1)}">S</span>
                                            </div>
                                            <div>
                                                <h4 style="font-size: 1rem; font-weight: 600; margin: 0;"
                                                    th:text="${childFee.studentName}">Student Name</h4>
                                                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">ID:
                                                    <span th:text="${childFee.studentId}">000</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">Bill</div>
                                            <div style="font-weight: 600;"
                                                th:text="${'â‚¦' + #numbers.formatDecimal(childFee.total, 1, 'COMMA', 2, 'POINT')}">
                                                â‚¦0</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">Paid</div>
                                            <div class="text-success" style="font-weight: 600;"
                                                th:text="${'â‚¦' + #numbers.formatDecimal(childFee.settled, 1, 'COMMA', 2, 'POINT')}">
                                                â‚¦0</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">Balance</div>
                                            <div th:classappend="${childFee.balance > 0 ? 'text-danger' : 'text-success'}"
                                                style="font-weight: 600;"
                                                th:text="${'â‚¦' + #numbers.formatDecimal(childFee.balance, 1, 'COMMA', 2, 'POINT')}">
                                                â‚¦0</div>
                                        </div>
                                    </div>

                                    <div class="fee-items-section">
                                        <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">Fee
                                            Items:</div>
                                        <ul class="fee-items-list" style="list-style: none; padding: 0;">
                                            <li th:each="item : ${childFee.items}" class="fee-item"
                                                style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.25rem;">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <input type="checkbox" th:if="${!item.isMandatory}"
                                                        th:checked="${item.isOptedIn}" th:disabled="${item.isLocked}"
                                                        th:attr="hx-post=@{/parent/student/{id}/toggle-fee(id=${childFee['studentUuid']})}"
                                                        hx-vals='js:{"feeItemId": event.target.getAttribute("data-fee-id"), "optedIn": event.target.checked}'
                                                        th:data-fee-id="${item.id}" hx-target="#fees-overview-section"
                                                        hx-swap="outerHTML" style="cursor: pointer;">

                                                    <span th:if="${!item.isMandatory && item.isLocked}"
                                                        title="Fee Locked" style="font-size: 0.8rem;">ðŸ”’</span>

                                                    <span class="fee-item-name" th:text="${item.name}">Fee Item</span>
                                                    <span th:if="${!item.isMandatory}" class="badge badge-secondary"
                                                        style="font-size: 0.7rem; padding: 2px 6px;">Optional</span>
                                                </div>
                                                <span class="fee-item-amount"
                                                    th:text="${'â‚¦' + #numbers.formatDecimal(item.amount, 1, 'COMMA', 2, 'POINT')}">â‚¦0.00</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div th:if="${#lists.isEmpty(feeBreakdown)}" class="empty-state">
                                <i class="fas fa-file-invoice"
                                    style="font-size: 2rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                                <p>No fee information available</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Children Tab -->
                <div id="children-tab" class="tab-pane">
                    <div class="content-panel">
                        <div class="section-header">
                            <h2 class="section-title">Children Overview</h2>
                        </div>

                        <!-- Child Sub-Tabs -->
                        <div class="tabs-container" th:if="${!#lists.isEmpty(children)}">
                            <div class="tabs-nav"
                                style="justify-content: flex-start; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
                                <button th:each="child, iter : ${children}" class="tab-btn"
                                    th:classappend="${iter.index == 0 ? 'active' : ''}"
                                    th:data-tab-target="'child-pane-' + ${child.id}">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="width: 24px; height: 24px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;"
                                            th:text="${#strings.substring(child.user.fullName, 0, 1)}">S</div>
                                        <span th:text="${child.user.fullName}">Student Name</span>
                                    </div>
                                </button>
                            </div>

                            <!-- Child Detail Panes -->
                            <div class="child-detail-panes">
                                <div th:each="child, iter : ${children}" th:id="'child-pane-' + ${child.id}"
                                    class="tab-pane" th:classappend="${iter.index == 0 ? 'active' : ''}">

                                    <div class="dashboard-grid">
                                        <div class="dashboard-card">
                                            <div class="card-header">
                                                <span class="card-title">Academic Info</span>
                                                <div class="card-icon"><i class="fas fa-graduation-cap"></i></div>
                                            </div>
                                            <div class="info-list"
                                                style="display: flex; flex-direction: column; gap: 1rem;">
                                                <div class="info-item">
                                                    <span class="text-muted" style="font-size: 0.85rem;">Current
                                                        Grade</span>
                                                    <div style="font-weight: 600;"
                                                        th:text="${child.currentGradeLevel ?: 'Not Assigned'}">Grade
                                                    </div>
                                                </div>
                                                <div class="info-item">
                                                    <span class="text-muted" style="font-size: 0.85rem;">Admission
                                                        No</span>
                                                    <div style="font-weight: 600;" th:text="${child.admissionNumber}">
                                                        000</div>
                                                </div>
                                                <div class="info-item">
                                                    <span class="text-muted" style="font-size: 0.85rem;">Status</span>
                                                    <div style="font-weight: 600;" th:text="${child.academicStatus}">
                                                        Enrolled</div>
                                                </div>
                                                <div class="info-item">
                                                    <span class="text-muted" style="font-size: 0.85rem;">Admission
                                                        Date</span>
                                                    <div style="font-weight: 600;"
                                                        th:text="${#temporals.format(child.admissionDate, 'dd MMM yyyy')}">
                                                        Date</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="dashboard-card">
                                            <div class="card-header">
                                                <span class="card-title">Personal Info</span>
                                                <div class="card-icon"><i class="fas fa-user"></i></div>
                                            </div>
                                            <div class="info-list"
                                                style="display: flex; flex-direction: column; gap: 1rem;">
                                                <div class="info-item">
                                                    <span class="text-muted"
                                                        style="font-size: 0.85rem;">Transportation</span>
                                                    <div style="font-weight: 600;"
                                                        th:text="${child.transportationMethod ?: 'Not Specified'}">
                                                        Method</div>
                                                </div>
                                                <div class="info-item">
                                                    <span class="text-muted" style="font-size: 0.85rem;">Special
                                                        Needs</span>
                                                    <div style="font-weight: 600;"
                                                        th:text="${child.hasSpecialNeeds ? 'Yes' : 'No'}">No</div>
                                                </div>
                                                <div class="info-item" th:if="${child.previousSchool}">
                                                    <span class="text-muted" style="font-size: 0.85rem;">Previous
                                                        School</span>
                                                    <div style="font-weight: 600;" th:text="${child.previousSchool}">
                                                        School Name</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="actions-grid" style="margin-top: 1.5rem;">
                                        <a th:href="@{'/parent/child/' + ${child.id}}" class="action-card">
                                            <div class="action-icon"><i class="fas fa-id-card"></i></div>
                                            <div class="action-title">View Full Profile</div>
                                        </a>
                                        <button class="action-card tab-btn" data-tab-target="financial-tab"
                                            style="text-align: left; border: none; width: 100%;">
                                            <div class="action-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                                            <div class="action-title">View Financials</div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(children)}" class="empty-state">
                            <i class="fas fa-child"
                                style="font-size: 2rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                            <h3>No Children Found</h3>
                            <p>Please contact the school administrator.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Sortable if available
            const el = document.getElementById('sortable-children');
            if (el && typeof Sortable !== 'undefined') {
                try {
                    const isLocked = el.classList.contains('locked');
                    new Sortable(el, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        disabled: isLocked,
                        onEnd: function () {
                            // Trigger change check if needed
                            const event = new Event('change', { bubbles: true });
                            el.dispatchEvent(event);
                        }
                    });
                } catch (e) {
                    console.error('Sortable init error:', e);
                }
            }

            // Payment settings change tracking
            const saveBtn = document.getElementById('save-settings-btn');
            const form = document.querySelector('.distribution-form');
            if (form && saveBtn) {
                form.addEventListener('change', function () {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                });
            }

            // Auto-switch to financial tab if there are alerts
            if (document.querySelector('#fees-overview-section .alert')) {
                const financialTabBtn = document.querySelector('.tab-btn[data-tab-target="financial-tab"]');
                if (financialTabBtn) {
                    financialTabBtn.click();
                }
            }
        });
    </script>
    <script th:src="@{/js/dashboard-tabs.js}"></script>
</body>

</html>