<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Manage Class Assignments</h2>
            <span class="fee-item-name" th:text="${feeItem.name}">Tuition Fee</span>
            <button type="button" class="modal-close" onclick="closeModal('classAssignmentModal')">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Currently Assigned Classes -->
            <div class="assigned-classes-section" th:if="${!#lists.isEmpty(assignedClassFeeItems)}">
                <h3>Currently Assigned Classes</h3>
                <div class="assigned-classes-grid">
                    <div th:each="classFeeItem : ${assignedClassFeeItems}" class="assigned-class-item">
                        <div class="class-info">
                            <span class="class-name" th:text="${classFeeItem.schoolClass.className}">Class 1A</span>
                            <span class="academic-year" th:text="${classFeeItem.academicYear}">2024-2025</span>
                            <div class="amount-info">
                                <span th:if="${classFeeItem.customAmount}" class="custom-amount">
                                    Custom: ₦<span
                                        th:text="${#numbers.formatDecimal(classFeeItem.customAmount, 0, 'COMMA', 2, 'POINT')}">45,000.00</span>
                                </span>
                                <span th:unless="${classFeeItem.customAmount}" class="default-amount">
                                    Default: ₦<span
                                        th:text="${#numbers.formatDecimal(feeItem.amount, 0, 'COMMA', 2, 'POINT')}">50,000.00</span>
                                </span>
                            </div>
                        </div>
                        <div class="class-actions">
                            <button class="btn btn-sm btn-danger"
                                th:hx-post="@{/admin/financial/fee-items/{feeItemId}/classes/{classId}/remove(feeItemId=${feeItem.id}, classId=${classFeeItem.schoolClass.id})}"
                                hx-target="#messageContainer" hx-swap="innerHTML"
                                th:attr="hx-headers='{&quot;X-CSRF-TOKEN&quot;: &quot;' + ${_csrf.token} + '&quot;}'">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Classes to Assign -->
            <div class="available-classes-section">
                <h3>Available Classes</h3>
                <form th:hx-post="@{/admin/financial/fee-items/{id}/classes/assign(id=${feeItem.id})}"
                    hx-target="#messageContainer" hx-swap="innerHTML" id="assignClassForm"
                    th:attr="hx-headers='{&quot;X-CSRF-TOKEN&quot;: &quot;' + ${_csrf.token} + '&quot;}'">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="classSelect">Select Class:</label>
                            <select id="classSelect" name="classId" class="form-select" required>
                                <option value="">Choose a class...</option>
                                <option th:each="schoolClass : ${allClasses}" th:value="${schoolClass.id}"
                                    th:text="${schoolClass.className}"
                                    th:disabled="${#lists.contains(assignedClassIds, schoolClass.id)}">
                                    Class 1A
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="academicYear">Academic Year:</label>
                            <input type="text" id="academicYear" name="academicYear" class="form-input"
                                value="2024-2025" required>
                        </div>

                        <div class="form-group">
                            <label for="academicSession">Academic Session:</label>
                            <select id="academicSession" name="academicSessionId" class="form-select" required>
                                <option value="">Choose a session...</option>
                                <option th:each="acadSession : ${academicSessions}" th:value="${acadSession.id}"
                                    th:text="${acadSession.sessionName != null ? acadSession.sessionName : 'Session'} + ${acadSession.year != null ? ' (' + acadSession.year + ')' : ''}">
                                    2024/2025 Session
                                </option>
                            </select>
                        </div>

                        <div class="form-group" id="termGroup" style="display: none;">
                            <label for="term">Term:</label>
                            <select id="term" name="term" class="form-select">
                                <option value="">Choose a term...</option>
                                <option value="FIRST_TERM">First Term</option>
                                <option value="SECOND_TERM">Second Term</option>
                                <option value="THIRD_TERM">Third Term</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="customAmount">Custom Amount (Optional):</label>
                            <div class="input-group">
                                <span class="input-prefix">₦</span>
                                <input type="number" id="customAmount" name="customAmount" class="form-input"
                                    step="0.01" min="0" placeholder="Leave empty for default amount">
                            </div>
                            <small class="form-help">
                                Default amount: ₦<span
                                    th:text="${#numbers.formatDecimal(feeItem.amount, 0, 'COMMA', 2, 'POINT')}">50,000.00</span>
                            </small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Assign Class
                        </button>
                    </div>
                </form>
            </div>

            <!-- Message Container -->
            <div id="messageContainer" class="mt-3"></div>
        </div>
    </div>

    <script>
        // Show/hide term field based on fee item recurrence type
        document.addEventListener('DOMContentLoaded', function () {
            const feeItemRecurrenceType = /*[[${feeItem.recurrenceType?.name()}]]*/ '';
            const termGroup = document.getElementById('termGroup');
            const termSelect = document.getElementById('term');

            if (feeItemRecurrenceType === 'TERMLY') {
                termGroup.style.display = 'block';
                termSelect.required = true;
            } else {
                termGroup.style.display = 'none';
                termSelect.required = false;
                termSelect.value = '';
            }
        });

        // Refresh class assignments after successful operation
        window.refreshClassAssignments = function (feeItemId) {
            htmx.ajax('GET', `/admin/financial/fee-items/${feeItemId}/classes/modal`, {
                target: '#classAssignmentModal .modal-dialog',
                swap: 'innerHTML'
            });
        };

        // Handle form submission success
        document.addEventListener('htmx:afterRequest', function (event) {
            if (event.detail.successful && event.target.id === 'assignClassForm') {
                // Clear form
                document.getElementById('assignClassForm').reset();
                // Refresh the modal content
                setTimeout(() => refreshClassAssignments(/*[[${feeItem.id}]]*/ 1), 1000);
            }
        });
    </script>
</body>

</html>