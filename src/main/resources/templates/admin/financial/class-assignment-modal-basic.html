<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Manage Class Assignments</h2>
            <span class="fee-item-name" th:text="${feeItem.name}">Tuition Fee</span>
            <button type="button" class="modal-close" onclick="closeModal('classAssignmentModal')">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Currently Assigned Classes -->
            <div id="assignedClassesContainer" th:fragment="assignedClassesList">

                <div class="assigned-classes-section" th:if="${!#lists.isEmpty(assignedClassFeeItems)}">
                    <h3>Currently Assigned Classes</h3>
                    <div class="assigned-classes-grid">
                        <div th:each="classFeeItem : ${assignedClassFeeItems}" class="assigned-class-item">
                            <div class="class-info">
                                <span class="class-name" th:text="${classFeeItem.schoolClass.className}">Class 1A</span>
                                <!-- Removed academicYear as it doesn't exist on ClassFeeItem -->
                                <div class="session-term-info">
                                    <span
                                        th:if="${classFeeItem.academicSession != null and classFeeItem.academicSession.sessionName != null}"
                                        class="session-info"
                                        th:text="${classFeeItem.academicSession.sessionName}">2024/2025
                                        Session</span>
                                    <span th:if="${classFeeItem.termId != null}" class="term-info"
                                        th:text="${classFeeItem.termId.termName}">First Term</span>
                                </div>
                                <div class="amount-info">
                                    <span th:if="${classFeeItem.customAmount}" class="custom-amount">
                                        Custom: ₦<span
                                            th:text="${#numbers.formatDecimal(classFeeItem.customAmount, 0, 'COMMA', 2, 'POINT')}">45,000.00</span>
                                    </span>
                                    <span th:unless="${classFeeItem.customAmount}" class="default-amount">
                                        Default: ₦<span
                                            th:text="${#numbers.formatDecimal(feeItem.amount, 0, 'COMMA', 2, 'POINT')}">50,000.00</span>
                                    </span>
                                </div>
                            </div>
                            <div class="class-actions" style="display: flex; gap: 5px;">
                                <button type="button" class="btn btn-sm"
                                    th:classappend="${classFeeItem.isLocked ? 'btn-warning' : 'btn-secondary'}"
                                    th:hx-post="@{/admin/financial/fee-items/class-assignments/{id}/toggle-lock(id=${classFeeItem.id})}"
                                    th:hx-vals="'{&quot;locked&quot;: ' + (!classFeeItem.isLocked) + '}'"
                                    hx-target="#messageContainer" hx-swap="innerHTML"
                                    th:title="${classFeeItem.isLocked ? 'Unlock Fee' : 'Lock Fee'}">
                                    <i class="fas"
                                        th:classappend="${classFeeItem.isLocked ? 'fa-lock' : 'fa-lock-open'}"></i>
                                </button>

                                <button type="button" class="btn btn-sm btn-danger"
                                    th:hx-post="@{/admin/financial/fee-items/class-assignments/{id}/remove(id=${classFeeItem.id})}"
                                    hx-target="#messageContainer" hx-swap="innerHTML">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(assignedClassFeeItems)}" class="text-center text-muted my-3">
                    <p>No classes assigned yet.</p>
                </div>
            </div>

            <!-- Available Classes to Assign -->
            <div class="available-classes-section">
                <h3>Available Classes</h3>
                <form th:hx-post="@{/admin/financial/fee-items/{id}/classes/assign(id=${feeItem.id})}"
                    hx-target="#messageContainer" hx-swap="innerHTML" id="assignClassForm"
                    hx-on:htmx:after-request="if(event.detail.successful) this.reset()">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="classSelect">Select Classes:</label>
                            <select id="classSelect" name="classIds" class="form-select" multiple required
                                style="height: 200px;">
                                <option th:each="schoolClass : ${allClasses}" th:value="${schoolClass.id}"
                                    th:text="${schoolClass.className}">
                                    Class 1A
                                </option>
                            </select>
                            <small class="form-help">Hold Ctrl (Cmd on Mac) to select multiple classes.</small>
                        </div>

                        <div class="form-group">
                            <label for="customAmount">Custom Amount (Optional):</label>
                            <div class="input-group">
                                <span class="input-prefix">₦</span>
                                <input type="number" id="customAmount" name="customAmount" class="form-input"
                                    step="0.01" min="0" placeholder="Leave empty for default amount">
                            </div>
                            <small class="form-help">
                                Default amount: ₦<span
                                    th:text="${#numbers.formatDecimal(feeItem.amount, 0, 'COMMA', 2, 'POINT')}">50,000.00</span>
                            </small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Assign Classes
                        </button>
                    </div>
                </form>
            </div>

            <!-- Message Container -->
            <div id="messageContainer" class="mt-3"></div>
        </div>
    </div>

    <script th:inline="javascript">
        // Script removed - logic moved to hx-on attributes and global listener
    </script>
</body>

</html>