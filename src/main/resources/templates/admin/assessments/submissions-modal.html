<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="submissions-content">
        <div class="modal-header">
            <h3 class="modal-title">
                Submissions for <span th:text="${examination.title}">Exam Title</span>
            </h3>
            <button type="button" class="close-modal" onclick="closeModal('examinationModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <div th:fragment="submissions-list-container" id="submissionsListContainer">
                <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
                <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

                <!-- OOB Update for main page count -->
                <span th:if="${examination}" th:id="'exam-submission-count-' + ${examination.id}"
                    th:text="'(' + ${examination.submissionCount} + ')'" hx-swap-oob="true" class="submission-count">
                    (0)
                </span>

                <div id="submissionsTableContainer">
                    <div th:if="${#lists.isEmpty(submissions)}" class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h3>No Submissions Yet</h3>
                        <p>There are no submissions recorded for this examination.</p>
                    </div>

                    <div th:unless="${#lists.isEmpty(submissions)}" class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Admission No.</th>
                                    <th>Attempt</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Submitted At</th>
                                    <th th:if="${isAdmin}">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="submission : ${submissions}">
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar small"
                                                th:text="${#strings.substring(submission.student.user.firstName, 0, 1)}">
                                                A</div>
                                            <div>
                                                <span
                                                    th:text="${submission.student.user.firstName + ' ' + submission.student.user.lastName}">Student
                                                    Name</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td th:text="${submission.student.admissionNumber ?: submission.student.studentId}">
                                        ADM001</td>
                                    <td>
                                        <span class="badge badge-info"
                                            th:text="'Attempt ' + ${submission.attemptCount}">Attempt 1</span>
                                    </td>
                                    <td>
                                        <span th:if="${submission.score != null}"
                                            th:text="${submission.score} + ' / ' + ${examination.totalMarks}">80 /
                                            100</span>
                                        <span th:unless="${submission.score != null}">-</span>
                                    </td>
                                    <td>
                                        <span th:class="'status-badge status-' + ${submission.status}"
                                            th:text="${#strings.capitalize(#strings.replace(submission.status, '_', ' '))}">
                                            Submitted
                                        </span>
                                    </td>
                                    <td th:text="${#temporals.format(submission.submittedAt, 'dd MMM yyyy HH:mm')}">01
                                        Jan 2024 10:00</td>
                                    <td th:if="${isAdmin}">
                                        <button class="btn-icon danger" th:data-id="${submission.id}"
                                            onclick="deleteSubmission(this.getAttribute('data-id'))"
                                            title="Delete Submission">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('examinationModal')">Close</button>
        </div>

        <script th:if="${isAdmin}">
            function deleteSubmission(submissionId) {
                if (confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
                    const url = '/admin/assessments/examinations/submissions/' + submissionId + '/delete';
                    const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                    const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            [csrfHeader]: csrfToken
                        }
                    })
                        .then(response => response.text())
                        .then(html => {
                            // Check if the response is an error fragment
                            if (html.includes('alert-danger')) {
                                // Replace the whole modal content or just show error
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = html;
                                const errorMsg = tempDiv.querySelector('.alert-danger')?.textContent || 'Error deleting submission';
                                if (typeof showNotification === 'function') {
                                    showNotification(errorMsg, 'error');
                                } else {
                                    alert(errorMsg);
                                }
                            } else {
                                // Update the container
                                document.getElementById('submissionsListContainer').outerHTML = html;
                                if (typeof showNotification === 'function') {
                                    showNotification('Submission deleted successfully', 'success');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            if (typeof showNotification === 'function') {
                                showNotification('An error occurred while deleting the submission.', 'error');
                            } else {
                                alert('An error occurred while deleting the submission.');
                            }
                        });
                }
            }
        </script>
    </div>
</body>

</html>