<th:block th:fragment="questions-management-content">
    <style>
        /* Scoped styles for question management */
        .question-card-wrapper {
            position: relative;
            transition: all 0.3s ease;
        }

        .question-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .option-item {
            padding: 0.75rem 1rem;
            background: var(--bg-body);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            font-size: 0.95rem;
        }

        .option-label {
            font-weight: 700;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .quill-editor {
            background: white;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            border-color: var(--border-color) !important;
            min-height: 100px;
        }

        .quill-editor.minimal {
            min-height: 60px;
        }

        .ql-toolbar {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            border-color: var(--border-color) !important;
            background: var(--bg-body);
        }

        .ql-container {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            border-color: var(--border-color) !important;
            font-family: 'Inter', sans-serif !important;
            font-size: 1rem !important;
        }

        /* Modal Overrides */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }

        .custom-modal.active {
            display: flex;
        }

        .custom-modal-content {
            background-color: var(--bg-card);
            margin: 2rem auto;
            padding: 2rem;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <div class="questions-management" style="padding: 1.5rem;">
        <!-- Header -->
        <div class="section-header" style="margin-bottom: 2rem;">
            <div>
                <h2 class="section-title">Manage Questions</h2>
                <p style="color: var(--text-muted); margin-top: 0.25rem;">Add, edit, or remove questions for this
                    assessment.</p>
            </div>
            <button type="button" class="action-btn"
                style="background: white; border: 1px solid var(--border-color); color: var(--text-main);"
                onclick="goBackToAssessments()">
                <i class="fas fa-arrow-left"></i> Back to Assessments
            </button>
        </div>

        <!-- Meta Info -->
        <div class="dashboard-grid"
            style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem;">
            <div class="stat-badge" style="text-align: left; display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background: #eff6ff; color: #3b82f6; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div>
                    <span class="label" style="display: block; margin-bottom: 0.25rem;">Examination</span>
                    <span class="value" style="font-size: 1rem;" th:text="${examination.title}">Title</span>
                </div>
            </div>
            <div class="stat-badge" style="text-align: left; display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background: #f0fdf4; color: #22c55e; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                    <i class="fas fa-book"></i>
                </div>
                <div>
                    <span class="label" style="display: block; margin-bottom: 0.25rem;">Subject</span>
                    <span class="value" style="font-size: 1rem;"
                        th:text="${examination.subject.subjectName}">Subject</span>
                </div>
            </div>
            <div class="stat-badge" style="text-align: left; display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background: #fff7ed; color: #f97316; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                    <i class="fas fa-star"></i>
                </div>
                <div>
                    <span class="label" style="display: block; margin-bottom: 0.25rem;">Total Marks</span>
                    <span class="value" style="font-size: 1rem;" th:text="${examination.totalMarks}">100</span>
                </div>
            </div>
        </div>

        <!-- Existing Questions -->
        <div id="existingQuestionsList"
            style="display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 3rem;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
                <h3 class="section-title" style="font-size: 1.25rem; margin: 0;">Existing Questions</h3>
                <span class="badge" style="background: var(--bg-hover); color: var(--text-muted);"
                    th:text="${#lists.size(examination.questions)} + ' Questions'">0 Questions</span>
            </div>

            <div th:if="${#lists.isEmpty(examination.questions)}" id="noQuestionsMessage" class="empty-state"
                style="padding: 3rem; text-align: center; background: var(--bg-body); border-radius: var(--radius-lg); border: 1px dashed var(--border-color);">
                <i class="fas fa-clipboard-question"
                    style="font-size: 3rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <p style="color: var(--text-muted);">No questions added yet.</p>
            </div>

            <div th:each="question, iter : ${examination.questions}" class="dashboard-card question-card-wrapper"
                th:id="'question-' + ${question.id}" style="padding: 1.5rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
                    <span class="question-number" th:text="'Question ' + (${iter.index} + 1)">Question 1</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="action-btn"
                            style="background: #fff7ed; color: #ea580c; padding: 0.5rem;" th:data-id="${question.id}"
                            onclick="editQuestion(this.getAttribute('data-id'))" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button type="button" class="action-btn"
                            style="background: #fef2f2; color: #dc2626; padding: 0.5rem;" th:data-id="${question.id}"
                            onclick="deleteQuestion(this.getAttribute('data-id'))" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="question-content">
                    <div th:if="${question.instruction}" th:utext="${question.instruction}"
                        style="font-style: italic; color: var(--text-muted); margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-body); border-left: 3px solid var(--info-color); border-radius: 4px;">
                    </div>

                    <div class="question-text" th:utext="${question.questionText}"
                        style="font-size: 1.1rem; color: var(--text-main); margin-bottom: 1.5rem; line-height: 1.6;">
                    </div>

                    <div class="options-grid">
                        <div class="option-item"
                            th:classappend="${question.correctAnswer == 'A'} ? 'correct-option' : ''"
                            th:style="${question.correctAnswer == 'A'} ? 'border-color: var(--success-color); background: #f0fdf4;' : ''">
                            <span class="option-label">A</span>
                            <span th:utext="${question.optionA}"></span>
                        </div>
                        <div class="option-item"
                            th:classappend="${question.correctAnswer == 'B'} ? 'correct-option' : ''"
                            th:style="${question.correctAnswer == 'B'} ? 'border-color: var(--success-color); background: #f0fdf4;' : ''">
                            <span class="option-label">B</span>
                            <span th:utext="${question.optionB}"></span>
                        </div>
                        <div class="option-item" th:if="${question.optionC}"
                            th:classappend="${question.correctAnswer == 'C'} ? 'correct-option' : ''"
                            th:style="${question.correctAnswer == 'C'} ? 'border-color: var(--success-color); background: #f0fdf4;' : ''">
                            <span class="option-label">C</span>
                            <span th:utext="${question.optionC}"></span>
                        </div>
                        <div class="option-item" th:if="${question.optionD}"
                            th:classappend="${question.correctAnswer == 'D'} ? 'correct-option' : ''"
                            th:style="${question.correctAnswer == 'D'} ? 'border-color: var(--success-color); background: #f0fdf4;' : ''">
                            <span class="option-label">D</span>
                            <span th:utext="${question.optionD}"></span>
                        </div>
                        <div class="option-item" th:if="${question.optionE}"
                            th:classappend="${question.correctAnswer == 'E'} ? 'correct-option' : ''"
                            th:style="${question.correctAnswer == 'E'} ? 'border-color: var(--success-color); background: #f0fdf4;' : ''">
                            <span class="option-label">E</span>
                            <span th:utext="${question.optionE}"></span>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; align-items: center;">
                        <span class="badge"
                            style="background: var(--success-color); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.85rem;">
                            Correct: <span th:text="${question.correctAnswer}">A</span>
                        </span>
                        <span class="badge"
                            style="background: var(--text-main); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.85rem;">
                            <span th:text="${question.marks}">5</span> Marks
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add New Questions Form -->
        <form id="questionsForm" method="POST" class="content-panel"
            style="border-top: 4px solid var(--primary-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3 class="section-title" style="font-size: 1.25rem; margin: 0;">Add New Questions</h3>
                <button type="button" class="action-btn"
                    style="background: var(--bg-hover); color: var(--primary-color);" onclick="addQuestion()">
                    <i class="fas fa-plus"></i> Add Question Card
                </button>
            </div>

            <div id="newQuestionsList" style="display: flex; flex-direction: column; gap: 2rem;">
                <!-- New questions appended here -->
            </div>

            <div class="form-actions"
                style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="submit" class="action-btn" id="saveQuestionsBtn"
                    style="background: var(--primary-color); color: white; padding: 0.75rem 1.5rem; font-size: 1rem;">
                    <i class="fas fa-save"></i> Save All New Questions
                </button>
            </div>
        </form>

        <!-- Templates and Modals -->
        <template id="questionTemplate">
            <div class="dashboard-card question-card" data-index="__INDEX__"
                style="padding: 1.5rem; border: 1px solid var(--primary-color); box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <span class="question-number">New Question __NUMBER__</span>
                    <button type="button" class="action-btn"
                        style="color: var(--danger-color); background: transparent;" onclick="removeQuestion(this)">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Instruction
                        (Optional)</label>
                    <div class="quill-editor minimal" data-placeholder="e.g., Read the passage..."></div>
                    <input type="hidden" name="questions[__INDEX__].instruction">
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Question
                        Text <span style="color: var(--danger-color);">*</span></label>
                    <div class="quill-editor" data-placeholder="Type your question here..."></div>
                    <input type="hidden" name="questions[__INDEX__].questionText" required>
                </div>

                <div class="options-grid">
                    <div>
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-muted);">Option
                            A <span style="color: var(--danger-color);">*</span></label>
                        <div class="quill-editor minimal" data-placeholder="Option A"></div>
                        <input type="hidden" name="questions[__INDEX__].optionA" required>
                    </div>
                    <div>
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-muted);">Option
                            B <span style="color: var(--danger-color);">*</span></label>
                        <div class="quill-editor minimal" data-placeholder="Option B"></div>
                        <input type="hidden" name="questions[__INDEX__].optionB" required>
                    </div>
                    <div>
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-muted);">Option
                            C</label>
                        <div class="quill-editor minimal" data-placeholder="Option C"></div>
                        <input type="hidden" name="questions[__INDEX__].optionC">
                    </div>
                    <div>
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-muted);">Option
                            D</label>
                        <div class="quill-editor minimal" data-placeholder="Option D"></div>
                        <input type="hidden" name="questions[__INDEX__].optionD">
                    </div>
                    <div>
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-muted);">Option
                            E</label>
                        <div class="quill-editor minimal" data-placeholder="Option E"></div>
                        <input type="hidden" name="questions[__INDEX__].optionE">
                    </div>
                </div>

                <div style="display: flex; gap: 1.5rem; margin-top: 1.5rem;">
                    <div style="flex: 1;">
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Correct
                            Answer <span style="color: var(--danger-color);">*</span></label>
                        <select name="questions[__INDEX__].correctAnswer"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white;"
                            required>
                            <option value="A">Option A</option>
                            <option value="B">Option B</option>
                            <option value="C">Option C</option>
                            <option value="D">Option D</option>
                            <option value="E">Option E</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Marks
                            <span style="color: var(--danger-color);">*</span></label>
                        <input type="number" name="questions[__INDEX__].marks" value="1" step="0.5"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);"
                            required>
                    </div>
                </div>
            </div>
        </template>

        <!-- Edit Modal -->
        <div id="editQuestionModal" class="custom-modal">
            <div class="custom-modal-content">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h3 class="section-title" style="margin: 0;">Edit Question</h3>
                    <button type="button" class="action-btn" style="background: transparent; color: var(--text-muted);"
                        onclick="closeEditModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="edit-question-id">

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Instruction</label>
                        <div id="edit-instruction-editor" class="quill-editor minimal"></div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Question Text</label>
                        <div id="edit-questionText-editor" class="quill-editor"></div>
                    </div>

                    <div class="options-grid">
                        <div><label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Option A</label>
                            <div id="edit-optionA-editor" class="quill-editor minimal"></div>
                        </div>
                        <div><label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Option B</label>
                            <div id="edit-optionB-editor" class="quill-editor minimal"></div>
                        </div>
                        <div><label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Option C</label>
                            <div id="edit-optionC-editor" class="quill-editor minimal"></div>
                        </div>
                        <div><label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Option D</label>
                            <div id="edit-optionD-editor" class="quill-editor minimal"></div>
                        </div>
                        <div><label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Option E</label>
                            <div id="edit-optionE-editor" class="quill-editor minimal"></div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1.5rem; margin-top: 1.5rem;">
                        <div style="flex: 1;">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Correct
                                Answer</label>
                            <select id="edit-correctAnswer"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                                <option value="E">Option E</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Marks</label>
                            <input type="number" id="edit-marks" step="0.5"
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                        </div>
                    </div>
                </div>

                <div
                    style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="action-btn"
                        style="background: white; border: 1px solid var(--border-color); color: var(--text-main);"
                        onclick="closeEditModal()">Cancel</button>
                    <button type="button" class="action-btn" style="background: var(--primary-color); color: white;"
                        onclick="saveEditedQuestion()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Keep existing JS logic but ensure modal classes are correct
        (function () {
            // ... (Previous JS logic, but updated for new class names if needed)
            // Since I kept IDs mostly the same, the logic should hold.
            // I will include the full JS block to ensure it's present.

            console.log('Questions management script starting...');
            const examinationId = /*[[${examination.id}]]*/ null;
            const classId = /*[[${classId}]]*/ null;

            // ... (Quill setup and logic) ...
            // I'll paste the logic from previous file but ensure it targets the new modal class 'custom-modal'

            window.quillInstances = window.quillInstances || new Map();
            const MAX_IMAGE_SIZE = 500 * 1024;

            window.refreshQuestionsList = async function () {
                const url = `/staff/classes/${classId}/examinations/${examinationId}/questions`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to fetch questions');
                    const html = await response.text();
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const newList = tempDiv.querySelector('#existingQuestionsList');
                    const currentList = document.getElementById('existingQuestionsList');
                    if (newList && currentList) {
                        currentList.innerHTML = newList.innerHTML;
                    } else {
                        const contentArea = document.getElementById('class-detail-content');
                        if (contentArea) contentArea.innerHTML = html;
                    }
                } catch (err) { console.error(err); }
            };

            function ensureQuill() {
                return new Promise((resolve, reject) => {
                    if (typeof Quill !== 'undefined') { resolve(); return; }
                    if (window.loadingQuill) {
                        const check = setInterval(() => { if (typeof Quill !== 'undefined') { clearInterval(check); resolve(); } }, 100);
                        return;
                    }
                    window.loadingQuill = true;
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'https://cdn.quilljs.com/1.3.6/quill.snow.css';
                    document.head.appendChild(link);
                    const script = document.createElement('script');
                    script.src = 'https://cdn.quilljs.com/1.3.6/quill.min.js';
                    script.onload = () => { window.loadingQuill = false; resolve(); };
                    document.head.appendChild(script);
                });
            }

            window.initQuill = async function (container) {
                if (!container) return;
                await ensureQuill();
                const editors = container.querySelectorAll('.quill-editor');
                editors.forEach(editor => {
                    if (editor.classList.contains('ql-container')) return;
                    const isMinimal = editor.classList.contains('minimal');
                    const toolbarOptions = isMinimal ? [['bold', 'italic', 'underline'], ['image'], ['clean']] : [['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['image'], ['clean']];
                    const quill = new Quill(editor, { theme: 'snow', modules: { toolbar: toolbarOptions }, placeholder: editor.getAttribute('data-placeholder') || 'Type here...' });

                    // Image handler logic (omitted for brevity but assumed present)
                    quill.getModule('toolbar').addHandler('image', () => {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();
                        input.onchange = () => {
                            const file = input.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const range = quill.getSelection();
                                    quill.insertEmbed(range.index, 'image', e.target.result);
                                };
                                reader.readAsDataURL(file);
                            }
                        };
                    });

                    window.quillInstances.set(editor, quill);

                    // Sync content on change
                    quill.on('text-change', () => {
                        const input = editor.nextElementSibling;
                        if (input) input.value = quill.root.innerHTML;
                    });
                });
            };

            window.addQuestion = async function () {
                const template = document.getElementById('questionTemplate');
                const container = document.getElementById('newQuestionsList');
                const index = window.questionsManagement ? window.questionsManagement.questionCount : document.querySelectorAll('.question-card').length;

                let html = template.innerHTML.replace(/__INDEX__/g, index).replace(/__NUMBER__/g, index + 1);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const card = tempDiv.firstElementChild;
                container.appendChild(card);
                await window.initQuill(card);

                if (window.questionsManagement) window.questionsManagement.questionCount = index + 1;
                card.scrollIntoView({ behavior: 'smooth' });
            };

            window.removeQuestion = function (btn) {
                const card = btn.closest('.question-card');
                if (card) {
                    card.querySelectorAll('.quill-editor').forEach(e => window.quillInstances.delete(e));
                    card.remove();
                }
            };

            // Edit Logic
            window.editQuestion = async function (questionId) {
                const url = `/staff/classes/${classId}/questions/${questionId}`;
                const response = await fetch(url);
                const data = await response.json();

                const modal = document.getElementById('editQuestionModal');
                document.body.appendChild(modal); // Move to body

                document.getElementById('edit-question-id').value = data.id;
                document.getElementById('edit-correctAnswer').value = data.correctAnswer;
                document.getElementById('edit-marks').value = data.marks;

                modal.classList.add('active'); // Use active class

                await window.initQuill(modal);

                // Set content
                const setContent = (id, content) => {
                    const el = document.getElementById(id);
                    const quill = window.quillInstances.get(el);
                    if (quill && content) quill.root.innerHTML = content;
                };

                setContent('edit-instruction-editor', data.instruction);
                setContent('edit-questionText-editor', data.questionText);
                setContent('edit-optionA-editor', data.optionA);
                setContent('edit-optionB-editor', data.optionB);
                setContent('edit-optionC-editor', data.optionC);
                setContent('edit-optionD-editor', data.optionD);
                setContent('edit-optionE-editor', data.optionE);
            };

            window.closeEditModal = function () {
                document.getElementById('editQuestionModal').classList.remove('active');
            };

            window.saveEditedQuestion = async function () {
                const id = document.getElementById('edit-question-id').value;
                const getContent = (id) => {
                    const el = document.getElementById(id);
                    const quill = window.quillInstances.get(el);
                    return quill ? quill.root.innerHTML : '';
                };

                const formData = new FormData();
                formData.append('instruction', getContent('edit-instruction-editor'));
                formData.append('questionText', getContent('edit-questionText-editor'));
                formData.append('optionA', getContent('edit-optionA-editor'));
                formData.append('optionB', getContent('edit-optionB-editor'));
                formData.append('optionC', getContent('edit-optionC-editor'));
                formData.append('optionD', getContent('edit-optionD-editor'));
                formData.append('optionE', getContent('edit-optionE-editor'));
                formData.append('correctAnswer', document.getElementById('edit-correctAnswer').value);
                formData.append('marks', document.getElementById('edit-marks').value);

                // CSRF
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');

                try {
                    const res = await fetch(`/staff/classes/${classId}/examinations/${examinationId}/questions/${id}/update`, {
                        method: 'POST',
                        headers: { 'X-CSRF-TOKEN': csrfToken },
                        body: formData
                    });
                    const result = await res.json();
                    if (result.success) {
                        closeEditModal();
                        refreshQuestionsList();
                    } else {
                        alert(result.message);
                    }
                } catch (e) { console.error(e); alert('Error saving question'); }
            };

            window.goBackToAssessments = function () {
                // Trigger click on assessments tab to reload
                const tab = document.querySelector('.tab-btn[data-tab="assessments"]');
                if (tab) tab.click();
            };

            // Form Submit for New Questions
            const form = document.getElementById('questionsForm');
            if (form) {
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    // Sync all quills
                    document.querySelectorAll('.quill-editor').forEach(editor => {
                        const input = editor.nextElementSibling;
                        const quill = window.quillInstances.get(editor);
                        if (input && quill) input.value = quill.root.innerHTML;
                    });

                    const formData = new FormData(this);
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');

                    try {
                        const res = await fetch(`/staff/classes/${classId}/examinations/${examinationId}/questions/save`, {
                            method: 'POST',
                            headers: { 'X-CSRF-TOKEN': csrfToken },
                            body: formData
                        });
                        const result = await res.json();
                        if (result.success) {
                            alert('Questions saved successfully!');
                            refreshQuestionsList();
                            document.getElementById('newQuestionsList').innerHTML = '';
                        } else {
                            alert(result.message);
                        }
                    } catch (e) { console.error(e); alert('Error saving questions'); }
                });
            }

        })();
    </script>
</th:block>